Vagrant.configure("2") do |config|
  config.vm.box = "bento/ubuntu-22.04"
  config.vm.hostname = "pulpo-cluster"
  config.vm.network "private_network", ip: "192.168.56.210"

  config.vm.provider "virtualbox" do |vb|
    vb.name = "pulpo-cluster"
    vb.memory = 8192
    vb.cpus = 4
  end

  config.vm.provision "shell", inline: <<-'SHELL'
    set -euo pipefail
    apt-get update -y
  SHELL

  config.vm.provision "shell",
    path: "requirements.sh",
    env: {
      "KIND_VERSION" => "0.27.0",
      "K8S_VERSION" => "v1.29.6",
      "HELM_INSTALL_SCRIPT" => "https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3",
      "FLUX_INSTALL_URL" => "https://fluxcd.io/install.sh",
      "KUBESEAL_VERSION" => "0.32.1"
    }

  config.vm.provision "shell",
    path: "bootstrap.sh",
    env: {
      "CILIUM_VERSION"  => "1.17.2",
      "K8S_VERSION"     => "v1.31.4",
      "CLUSTER_NAME"    => "kind-cilium",
      "KIND_NODE_IMAGE" => "kindest/node:v1.31.4"
    }

  config.vm.provision "shell",
    path: "haproxy.sh",
    env: {
      "LISTEN_PORT"  => "80",
      "BACKEND_ADDR" => "127.0.0.1",
      "BACKEND_PORT" => "30080"
    }

end
